/*! midi.js - v0.0.0 - 2013-05-20 */
(function(){var t,e,i,n,o={}.hasOwnProperty,s=function(t,e){function i(){this.constructor=t}for(var n in e)o.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};for(window.Midi||(window.Midi={}),Midi.Base=function(){function t(t){this.options=_.clone(this.defaultOptions),this.set(t)}return t.prototype.defaultOptions={},t.prototype.set=function(t){return _.merge(this.options,t),this},t}(),Midi.Amplifier=function(t){function e(){return n=e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.defaultOptions={volume:100},e}(Midi.Base),Midi.NOTES_TO_NUMBER={},Midi.NOTES=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],t=21;108>=t;)i=(t-12)/12>>0,e=Midi.NOTES[t%12]+i,Midi.NOTES_TO_NUMBER[e]=t,t++;Midi.Device=function(t){function e(t){e.__super__.constructor.call(this,t),this._sources={},this._audioBuffers={},this._ctx=new window.webkitAudioContext,this._soundFontLoader()}return s(e,t),e.prototype.defaultOptions={onReady:function(){return{}},soundFont:Midi.Soundfont.acoustic_grand_piano},e.prototype.noteOn=function(t,e,i,n){var o;return this._audioBuffers[e]?(o=this._createAudioGraph(t,e,i),o.start(this._toDeviceTime(n)),this):this},e.prototype.noteOff=function(t,e,i){var n;return(n=this._sources[t+""+e])?(n.gain.linearRampToValueAtTime(1,this._toDeviceTime(i)),n.gain.linearRampToValueAtTime(0,this._toDeviceTime(i+500)),n.stop(this._toDeviceTime(i+800)),delete this._sources[t+""+e],this):this},e.prototype.currentTime=function(){return 1e3*this._ctx.currentTime},e.prototype.flushSources=function(){return _.each(this._sources,function(t){return t.stop(0)}),this._sources={},this},e.prototype._toDeviceTime=function(t){return t/1e3},e.prototype._createAudioGraph=function(t,e,i){var n,o,s;return s=this._ctx.createBufferSource(),s.buffer=this._audioBuffers[e],n=this._ctx.createGainNode(),o=2*(i/127)-1,n.gain.gainValue=Math.max(-1,o),s.connect(n),n.connect(this._ctx.destination),s},e.prototype._soundFontLoader=function(){var t,e,i=this;return t=_.keys(this.options.soundFont),e=0,_.each(t,function(n){var o,s;return o=i.options.soundFont[n].split(",")[1],s=Base64Binary.decodeArrayBuffer(o),i._ctx.decodeAudioData(s,function(o){return e+=1,i._audioBuffers[Midi.NOTES_TO_NUMBER[n]]=o,e===t.length-1?i.options.onReady(i):void 0})})},e}(Midi.Base),Midi.Sequencer=function(t){function e(t){var i;this._state={playState:"STOPPED",eventIndex:0},e.__super__.constructor.call(this,t),(i=this.options).device||(i.device=new Midi.Device)}return s(e,t),e.prototype.defaultOptions={midiFile:void 0,device:void 0,scheduleInterval:100},e.prototype.playState=function(){return this._state.playState},e.prototype.set=function(t){return e.__super__.set.call(this,t),t.midiFile&&this._loadFile(t.midiFile),this},e.prototype._scheduleSound=function(t,e){switch(t=t[0].event,t.subtype){case"noteOn":return this.options.device.noteOn(t.channel,t.noteNumber,t.velocity,e);case"noteOff":return this.options.device.noteOff(t.channel,t.noteNumber,e)}},e.prototype.stop=function(t){return clearInterval(this._interval),this.options.device.flushSources(),t?void 0:(this._state.playState="STOPPED",this._state.eventIndex=0)},e.prototype.play=function(){return"PLAYING"===this._state.playState?(this._state.playState="PAUSED",this.stop(!0)):(this._state.scheduledTime=this.options.device.currentTime()+250,this._state.intervalEndTime=this.options.device.currentTime()+250,this._state.playState="PLAYING",this._playInterval(),this._interval=setInterval(_.bind(this._playInterval,this),this.options.scheduleInterval)),this},e.prototype._playInterval=function(){var t;for(this._state.intervalEndTime+=this.options.scheduleInterval;this._state.scheduledTime<this._state.intervalEndTime&&this._state.eventIndex<this._events.length;)t=this._events[this._state.eventIndex],this._scheduleSound(t,this._state.scheduledTime),this._state.scheduledTime+=t[1],this._state.eventIndex++;return this._state.eventIndex>=this._events.length?this.stop():void 0},e.prototype._loadFile=function(){var t,e,i;return this.stop(),i=window.atob(this.options.midiFile.split(",")[1]),e=MidiFile(i),t=new Replayer(e,1),this._events=t.getData()},e}(Midi.Base)}).call(this);